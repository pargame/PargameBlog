import{R as Y,j as m,r}from"./react-vendor-BCrD9jt_.js";import{l as n}from"./graph-modal-DxypMPMx.js";import{s as Z,a as re,l as ne,m as se,c as ae,x as ce,y as oe,d as ie,t as le,i as ue}from"./d3-PoVUD40l.js";import"./vendor-DA-qn-I4.js";import"./markdown-CN-Pbo1D.js";const de=({showMissing:x,onToggleShowMissing:f})=>m.jsx("div",{className:"graph-controls",children:m.jsxs("label",{className:"graph-controls-label",children:[m.jsx("input",{className:"graph-controls-checkbox",type:"checkbox",checked:x,onChange:f}),"누락 항목 포함"]})}),fe=Y.memo(de);function pe(x){const{svgRef:f,dims:d,width:P,height:A,data:N,onNodeClick:R,onBackgroundClick:I}=x,E=r.useRef(null),C=r.useRef(null),V=r.useRef(null),j=r.useRef(null),y=r.useRef(null),b=typeof window<"u"&&"matchMedia"in window?window.matchMedia("(prefers-reduced-motion: reduce)").matches:!1,L=.5,D=5,z=.9,$=.3,B=.05,K=1200,M=r.useCallback(()=>{const i=V.current,h=C.current,g=j.current;!i||!h||!g||(i.attr("x1",s=>typeof s.source=="string"?0:s.source.x??0).attr("y1",s=>typeof s.source=="string"?0:s.source.y??0).attr("x2",s=>typeof s.target=="string"?0:s.target.x??0).attr("y2",s=>typeof s.target=="string"?0:s.target.y??0),h.attr("cx",s=>s.x??d.w/2).attr("cy",s=>s.y??d.h/2),g.attr("x",s=>(s.x??d.w/2)+10).attr("y",s=>(s.y??d.h/2)+4))},[d.w,d.h]),_=r.useCallback(i=>{if(i)try{const h=i.nodes();for(const g of h)g._autoPinned&&(g.fx=null,g.fy=null,g._autoPinned=!1);i.alpha(1),i.alphaTarget($),i.restart(),y.current&&(window.clearTimeout(y.current),y.current=null),y.current=window.setTimeout(()=>{try{i.alphaTarget(B)}catch(g){n.debug("kick simulation relax failed",g)}y.current=null},K)}catch(h){n.debug("kickSimulation failed",h)}},[]),v=r.useCallback(()=>{try{E.current?.stop()}catch(i){n.debug("pauseSimulation failed",i)}},[]),q=r.useCallback(()=>{try{E.current?.restart()}catch(i){n.debug("resumeSimulation failed",i)}},[]);return r.useEffect(()=>{const i=f.current;if(!i)return;const h=Z(i),g=d.w||P,s=d.h||A;let t=h.select("g.zoom-layer");t.empty()&&(h.selectAll("*").remove(),h.attr("viewBox",`0 0 ${g} ${s}`).attr("preserveAspectRatio","xMidYMid meet"),h.insert("rect",":first-child").attr("class","bg-rect").attr("x",0).attr("y",0).attr("width",g).attr("height",s).attr("fill","transparent"),t=h.append("g").attr("class","zoom-layer"));const l=N.nodes,u=N.links;let o=t.select("g.links");o.empty()&&(o=t.append("g").attr("class","links"));let S=t.select("g.nodes");S.empty()&&(S=t.append("g").attr("class","nodes"));let p=t.select("g.labels");p.empty()&&(p=t.append("g").attr("class","labels")),o.selectAll("line").data(u).join(e=>e.append("line").attr("class","link"),e=>e,e=>e.remove()),V.current=o.selectAll("line"),S.selectAll("circle").data(l).join(e=>e.append("circle").attr("class",a=>`node${a.missing?" missing":""}`).attr("r",8).attr("fill","#2563eb").attr("pointer-events","all").on("click",(a,w)=>{a.stopPropagation(),w.missing||R?.({id:w.id,title:w.title,missing:w.missing})}),e=>e,e=>e.remove()),C.current=S.selectAll("circle"),p.selectAll("text").data(l).join(e=>e.append("text").attr("class","label").attr("font-size",11).attr("fill","#c9d4e3").attr("pointer-events","none").text(a=>a.title),e=>e.text(a=>a.title),e=>e.remove()),j.current=p.selectAll("text");const k=re(l).force("link",ne(u).id(e=>e.id).distance(120)).force("charge",se().strength(-180)).force("collision",ae().radius(18).strength(.7)).force("x",ce(g/2).strength(.05)).force("y",oe(s/2).strength(.05)).velocityDecay(.6).alpha(1).alphaDecay(.05);E.current=k,k.on("tick",()=>{try{M()}catch(e){n.debug("renderPositions failed",e)}try{const e=k.nodes();let a=0,w=0;for(const c of e){if(c._idleTicks=c._idleTicks??0,c._autoPinned=!!c._autoPinned,c._dragging&&w++,Math.sqrt((c.vx??0)**2+(c.vy??0)**2)<L?c._idleTicks=(c._idleTicks??0)+1:c._idleTicks=0,!c._autoPinned&&!c._dragging&&(c._idleTicks??0)>=D){try{c.vx=0,c.vy=0,c.fx=c.x??null,c.fy=c.y??null}catch(W){n.debug("pin failed",W)}c._autoPinned=!0}c._autoPinned&&a++}if((e.length>0?a/e.length:1)>=z&&w===0)try{k.stop()}catch(c){n.debug("sim stop failed",c)}}catch(e){n.debug("tick handler failed",e)}});try{C.current?.call(ie().on("start",(e,a)=>{a._dragging=!0,a.fx=a.x??null,a.fy=a.y??null}).on("drag",(e,a)=>{const w=e;a.fx=w.x,a.fy=w.y,_(k)}).on("end",(e,a)=>{a._dragging=!1,a.fx=null,a.fy=null}))}catch(e){n.debug("drag setup failed",e)}try{h.select(".bg-rect").on("click",e=>{e.stopPropagation(),I?.()})}catch(e){n.debug("bg handler failed",e)}return b||_(k),()=>{try{k.stop()}catch(e){n.debug("cleanup sim stop failed",e)}try{C.current=null}catch(e){n.debug("cleanup nodeSel clear failed",e)}try{V.current=null}catch(e){n.debug("cleanup linkSel clear failed",e)}try{j.current=null}catch(e){n.debug("cleanup labelSel clear failed",e)}try{E.current=null}catch(e){n.debug("cleanup simRef clear failed",e)}y.current&&(window.clearTimeout(y.current),y.current=null)}},[f,d.w,d.h,P,A,N,R,I,_,M,b]),{kickSimulation:_,pauseSimulation:v,resumeSimulation:q,prefersReducedMotion:b}}const he=Y.createContext(null),ge=({value:x,children:f})=>m.jsx(he.Provider,{value:x,children:f});class me extends Y.Component{constructor(f){super(f),this.state={hasError:!1}}static getDerivedStateFromError(){return{hasError:!0}}componentDidCatch(f,d){try{n.error("ErrorBoundary caught error",f,d)}catch{console.error("ErrorBoundary caught error",f,d)}}render(){return this.state.hasError?m.jsxs("div",{role:"alert",style:{padding:20},children:[m.jsx("h3",{children:"오류가 발생했습니다."}),m.jsx("p",{children:"그래프를 렌더링하는 중 문제가 발생했습니다. 새로고침하거나 문제를 보고해주세요."}),m.jsx("button",{onClick:()=>{try{const f="Graph error encountered at "+new Date().toISOString();navigator.clipboard?.writeText(f),alert("오류 정보가 클립보드에 복사되었습니다. 이 내용을 공유해주세요.")}catch{alert("오류 정보를 복사할 수 없습니다.")}},children:"오류 복사하기"})]}):this.props.children}}const ye=({data:x,width:f=800,height:d=520,onNodeClick:P,onBackgroundClick:A,selectedNodeId:N=null})=>{const R=r.useRef(null),I=r.useRef(null),[E,C]=r.useState({w:f,h:d}),V=r.useRef(!1),j=r.useRef(null),y=r.useRef(null),b=r.useRef(null),L=r.useRef(!1),D=r.useRef(null),z=r.useRef(null),$=r.useRef(null),[B,K]=r.useState(!0),[M,_]=r.useState(!1),v=r.useRef(!1);r.useEffect(()=>{const t=I.current;if(!t)return;const l=new ResizeObserver(u=>{const o=u[0]?.contentRect;o&&C({w:Math.max(320,o.width),h:Math.max(240,o.height)})});return l.observe(t),()=>l.disconnect()},[]),r.useEffect(()=>{const t=R.current;if(!t||typeof IntersectionObserver>"u")return;const l=b.current,u=new IntersectionObserver(o=>{const S=o[0];try{if(S&&!S.isIntersecting)try{b.current?.stop(),L.current=!0}catch(p){n.debug("GraphView: stop failed",p)}else try{b.current&&(b.current.alpha(.1).restart(),L.current=!1)}catch(p){n.debug("GraphView: restart failed",p)}}catch(p){n.debug("GraphView: intersection handler failed",p)}},{threshold:0});return u.observe(t),()=>{try{l?.stop()}catch(o){n.debug("GraphView: cleanup stop failed",o)}try{u.disconnect()}catch(o){n.debug("GraphView: observer disconnect failed",o)}}},[R,b]);const q={initializedRef:V,kickTimerRef:j,zoomRef:y,simulationRef:b,nodeSelRef:D,linkSelRef:z,labelSelRef:$,simulationStoppedRef:L,panInProgressRef:v},[i,h]=r.useState(null),g=r.useCallback(t=>{try{h(t.id)}catch(l){n.debug("GraphView: setLastClickedNodeId failed",l)}try{P?.(t)}catch(l){n.debug("GraphView: forwarded onNodeClick failed",l)}},[P]),s=pe({svgRef:R,dims:E,width:f,height:d,data:{nodes:x.nodes,links:x.links},onNodeClick:g,onBackgroundClick:A});return r.useEffect(()=>{if(!i)return;const t=R.current,l=y.current,u=D.current;if(!(!t||!l||!u))try{const o=u.filter(G=>G.id===i);if(!o||typeof o.node!="function"||!o.node())return;const p=o.node().getBoundingClientRect();if(!p)return;const O=Z(t),H=le(O.node()),X=H.k||1,k=p.left+p.width/2,e=p.top+p.height/2,a=typeof window<"u"&&typeof window.innerWidth=="number"?window.innerWidth:800,w=typeof window<"u"&&typeof window.innerHeight=="number"?window.innerHeight:600,F=a*.25,c=w*.5,J=F-k,W=c-e,Q=H.x+J,U=H.y+W,ee=ue.translate(Q,U).scale(X);try{try{v.current=!0}catch(T){n.debug("GraphView: failed to mark panInProgress start",T)}const G=y.current.transform;typeof G=="function"?O.transition().duration(400).call(G,ee).on("end interrupt",()=>{try{v.current=!1}catch(T){n.debug("GraphView: failed to clear panInProgress",T)}}):O.select("g.zoom-layer").transition().duration(400).attr("transform",`translate(${Q},${U}) scale(${X})`).on("end interrupt",()=>{try{v.current=!1}catch(te){n.debug("GraphView: failed to clear panInProgress",te)}})}catch(G){try{v.current=!1}catch(T){n.debug("GraphView: failed to clear panInProgress on error",T)}n.debug("GraphView: vertical pan failed",G)}}catch(o){n.debug("GraphView: vertical pan setup failed",o)}},[i,E.h,d,v]),r.useEffect(()=>{try{if(typeof window<"u"&&"matchMedia"in window){const t=window.matchMedia("(prefers-reduced-motion: reduce)");_(!!t.matches);const l=u=>_(!!u.matches);if(typeof t.addEventListener=="function")t.addEventListener("change",l);else{const u=t;typeof u.addListener=="function"&&u.addListener(l)}return()=>{if(typeof t.removeEventListener=="function")t.removeEventListener("change",l);else{const u=t;typeof u.removeListener=="function"&&u.removeListener(l)}}}}catch(t){n.debug("GraphView: mq setup failed",t)}},[]),r.useEffect(()=>{if(M)try{s.pauseSimulation?.()}catch(t){n.debug("GraphView: pauseSimulation failed",t)}return()=>{try{s.pauseSimulation?.()}catch(t){n.debug("GraphView: cleanup pauseSimulation failed",t)}}},[M,s]),m.jsx(me,{children:m.jsx(ge,{value:q,children:m.jsxs("div",{ref:I,className:"graph-wrap",children:[m.jsx("svg",{ref:R,role:"img","aria-label":"graph view"}),m.jsx(fe,{showMissing:B,onToggleShowMissing:r.useCallback(()=>K(t=>!t),[])})]})})})},ve=r.memo(ye);export{ve as default};
//# sourceMappingURL=graph-view-CygAmUIF.js.map
